x-zane-env:
  POSTGRES_PASSWORD: "{{ generate_password | 32 }}"
  __DATABASE_URL: "postgres://guestbook:${POSTGRES_PASSWORD}@db:5432/guestbook?schema=public"

services:
  db:
    image: postgres:18-alpine
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -d $$POSTGRES_DB -U $$POSTGRES_USER"]
      start_period: 20s
      interval: 30s
      retries: 5
      timeout: 5s
    volumes:
      - db-data:/var/lib/postgresql
    environment:
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-guestbook}
      POSTGRES_USER: ${POSTGRES_USER:-guestbook}
      POSTGRES_DB: ${POSTGRES_DB:-guestbook}
  redis:
    image: valkey/valkey:8-alpine
    healthcheck:
      test:
        - CMD-SHELL
        - valkey-cli ping | grep PONG
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 10s
volumes:
  db-data:
